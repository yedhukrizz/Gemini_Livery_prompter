<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Livery Styler Pro</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --bg-body: #050507;
            --bg-panel: rgba(20, 20, 25, 0.6); /* Glassy base */
            --bg-surface: rgba(255, 255, 255, 0.05);
            --bg-surface-hover: rgba(255, 255, 255, 0.08);
            
            /* Theme Colors */
            --primary: #ec4899; 
            --primary-hover: #db2777;
            --primary-glow: rgba(236, 72, 153, 0.25);
            
            /* Coffee Color */
            --coffee: #FFDD00;
            
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --text-dim: #52525b;
            
            /* Glass Borders */
            --border: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.15);
            
            --radius-md: 16px;
            --shadow-lg: 0 20px 50px -10px rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevent body scroll, handle internally */
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            display: flex;
            position: relative;
            touch-action: pan-y; /* Allow vertical scroll gestures */
        }

        /* --- Animated Background --- */
        .ambient-glow {
            position: absolute;
            inset: 0;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: floatOrb 20s infinite alternate ease-in-out;
        }

        .orb-1 {
            top: -10%; left: -10%;
            width: 50vw; height: 50vw;
            background: radial-gradient(circle, var(--primary), transparent 70%);
            animation-duration: 25s;
        }

        .orb-2 {
            bottom: -10%; right: -10%;
            width: 60vw; height: 60vw;
            background: radial-gradient(circle, #6366f1, transparent 70%);
            animation-duration: 30s;
            animation-direction: alternate-reverse;
        }

        .orb-3 {
            top: 40%; left: 40%;
            width: 40vw; height: 40vw;
            background: radial-gradient(circle, #8b5cf6, transparent 70%);
            animation-duration: 22s;
        }

        @keyframes floatOrb {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(50px, -50px) scale(1.1); }
        }

        /* --- Layout --- */
        .app-container {
            display: grid;
            grid-template-columns: 380px 1fr;
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* --- Glass Sidebar --- */
        aside {
            background: var(--bg-panel);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            position: relative;
            z-index: 50;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 10px 0 30px rgba(0,0,0,0.2);
        }

        .sidebar-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            flex-shrink: 0; /* Prevent header shrinking */
        }

        .brand {
            font-weight: 700;
            font-size: 0.95rem;
            letter-spacing: -0.01em;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }
        .brand i { color: var(--primary); font-size: 1.2rem; }

        .close-sidebar-btn {
            display: none;
            background: none; border: none; color: var(--text-muted);
            font-size: 1.5rem; cursor: pointer;
        }

        .scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling iOS */
        }

        /* --- UI Components --- */
        details {
            margin-bottom: 1rem;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: background 0.2s;
        }
        details:hover { background: var(--bg-surface-hover); }

        summary {
            padding: 14px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            list-style: none;
            user-select: none;
        }
        summary::-webkit-details-marker { display: none; }
        .summary-title { display: flex; align-items: center; gap: 10px; }
        .chevron { transition: transform 0.3s; color: var(--text-dim); }
        details[open] .chevron { transform: rotate(180deg); }
        .panel-content { padding: 14px; border-top: 1px solid var(--border); }

        .input-group { margin-bottom: 1rem; }
        label {
            display: block; font-size: 0.7rem; font-weight: 600;
            text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px;
        }

        input, select, textarea {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            color: white;
            padding: 10px 12px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 16px; /* 16px prevents iOS auto-zoom */
            transition: border 0.2s, background 0.2s;
            -webkit-appearance: none;
        }
        
        textarea {
            /* Force 16px for mobile to avoid zoom, visually adjust later if needed */
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.5;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            background: rgba(0,0,0,0.5);
            box-shadow: 0 0 0 2px var(--primary-glow);
        }

        /* Range Slider */
        .range-wrap { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        input[type=range] { flex: 1; padding: 0; height: 4px; border: none; background: var(--border); appearance: none; border-radius: 2px;}
        input[type=range]::-webkit-slider-thumb {
            appearance: none; width: 16px; height: 16px; border-radius: 50%;
            background: var(--primary); border: 2px solid var(--bg-body); box-shadow: 0 0 10px var(--primary); cursor: pointer;
        }
        .range-val { font-size: 0.75rem; font-family: 'JetBrains Mono', monospace; color: var(--primary); width: 32px; text-align: right; }

        /* Toggle */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; inset: 0; background-color: var(--border);
            border-radius: 20px; transition: .3s;
        }
        .slider:before {
            position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
            background-color: #52525b; border-radius: 50%; transition: .3s;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); background-color: white; }

        /* --- Main Content --- */
        main {
            display: flex; flex-direction: column;
            background: rgba(5, 5, 7, 0.3); /* Transparent to see background */
            backdrop-filter: blur(10px);
            position: relative;
            height: 100%;
            overflow: hidden;
        }

        .top-bar {
            height: 60px;
            border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column;
            background: rgba(10, 10, 12, 0.6);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        .top-header {
            flex: 1; display: flex; align-items: center; justify-content: space-between; padding: 0 1rem;
        }

        .mobile-menu-btn {
            display: none;
            background: transparent; border: none; color: white; font-size: 1.5rem; margin-right: 10px; cursor: pointer;
        }

        .tabs { display: flex; gap: 2rem; padding: 0 1rem; background: rgba(0,0,0,0.2); }
        .tab-btn {
            background: none; border: none; color: var(--text-muted);
            font-family: 'Inter', sans-serif; font-weight: 500; font-size: 0.85rem;
            padding: 12px 0; cursor: pointer; position: relative; transition: color 0.2s;
        }
        .tab-btn.active { color: var(--text-main); }
        .tab-btn.active::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px;
            background: var(--primary); box-shadow: 0 -2px 10px var(--primary);
        }

        .actions { display: flex; gap: 8px; }
        .btn-icon {
            background: var(--bg-surface); border: 1px solid var(--border); color: var(--text-main);
            width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: all 0.2s;
        }
        .btn-icon:hover { border-color: var(--text-muted); background: var(--bg-surface-hover); }

        /* Tab Content */
        .tab-content { display: none; flex: 1; overflow: hidden; position: relative; height: 100%; }
        .tab-content.active { display: flex; }

        /* Editor */
        .editor-wrap { flex: 1; position: relative; display: flex; overflow: hidden; }
        .line-numbers {
            width: 30px; background: rgba(0,0,0,0.2); border-right: 1px solid var(--border);
            color: #52525b; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem;
            line-height: 1.5; padding-top: 1rem; text-align: right; padding-right: 8px;
            user-select: none; display: none;
            overflow: hidden;
        }
        #output {
            flex: 1; background: rgba(0,0,0,0.2); border: none; color: #d4d4d8;
            font-family: 'JetBrains Mono', monospace; font-size: 16px; /* Fixed for mobile zoom */
            line-height: 1.5;
            padding: 1rem; resize: none;
        }

        /* --- Welcome Popup (New) --- */
        .welcome-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 200;
            display: none; /* Hidden by default */
            align-items: center; justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .welcome-overlay.active {
            display: flex;
            opacity: 1;
        }

        .welcome-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 500px;
            width: 100%;
            animation: popupFloat 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popupFloat {
            from { transform: translateY(30px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .welcome-img {
            width: 100%;
            height: auto;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            display: block;
        }

        .welcome-btn {
            background: linear-gradient(135deg, var(--primary), #db2777);
            color: white; border: none; padding: 14px 32px; border-radius: 50px;
            font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 15px var(--primary-glow);
            font-size: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .welcome-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px var(--primary-glow);
        }

        /* --- Coffee Modal --- */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .glass-modal {
            background: rgba(30, 30, 35, 0.7);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-lg), 0 0 40px rgba(236, 72, 153, 0.1);
            padding: 2rem;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: translateY(20px);
            transition: transform 0.3s;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .modal-overlay.active .glass-modal { transform: translateY(0); }

        .modal-content h2 { margin-top: 0; font-size: 1.4rem; color: white; }
        .modal-content p { color: var(--text-muted); line-height: 1.5; margin-bottom: 1.5rem; }
        
        .coffee-btn-modal {
            display: inline-flex; align-items: center; gap: 8px;
            background: var(--coffee); color: #000; text-decoration: none;
            padding: 12px 24px; border-radius: 50px; font-weight: 700;
            box-shadow: 0 4px 15px rgba(255, 221, 0, 0.3);
            transition: transform 0.2s;
            width: 100%; justify-content: center;
            font-size: 16px; /* Prevent zoom */
        }
        .coffee-btn-modal:hover { transform: scale(1.05); }

        .modal-footer { margin-top: 1.5rem; display: flex; flex-direction: column; gap: 10px; }
        .close-modal-btn {
            background: transparent; border: 1px solid var(--border); color: var(--text-muted);
            padding: 10px; border-radius: 8px; cursor: pointer; font-size: 0.85rem;
            transition: all 0.2s;
            width: 100%;
        }
        .close-modal-btn:hover { background: var(--bg-surface); color: white; }

        .dont-show-check {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 0.8rem; color: var(--text-dim); margin-top: 10px; cursor: pointer;
            user-select: none;
        }
        .dont-show-check input { width: auto; margin: 0; }

        /* --- View Specifics --- */
        .about-container {
            flex: 1; padding: 1.5rem; overflow-y: auto; max-width: 800px; margin: 0 auto; width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        .step {
            background: var(--bg-surface); border: 1px solid var(--border); border-radius: 12px;
            padding: 1.2rem; margin-bottom: 1rem;
        }
        .step h3 { margin: 0 0 0.5rem 0; font-size: 1rem; color: white; display: flex; align-items: center; gap: 8px; }
        .step p { margin: 0; color: var(--text-muted); font-size: 0.9rem; line-height: 1.4; }
        
        .credits-wrapper {
            margin-top: 3rem;
            text-align: center;
            padding: 2rem;
            background: linear-gradient(180deg, rgba(236, 72, 153, 0.1) 0%, rgba(0,0,0,0) 100%);
            border: 1px solid rgba(236, 72, 153, 0.2);
            border-radius: 16px;
        }
        .dev-name { font-size: 1.5rem; font-weight: 800; color: white; margin: 0.5rem 0 0.5rem 0; }
        .made-with { color: var(--text-muted); font-size: 0.95rem; }
        .heart-icon { color: var(--primary); display: inline-block; animation: heartbeat 1.5s infinite; }
        
        .sidebar-footer { padding: 1rem; border-top: 1px solid var(--border); background: rgba(0,0,0,0.2); flex-shrink: 0; }
        .btn-generate {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), #db2777);
            color: white; border: none; padding: 12px; border-radius: 8px;
            font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
            box-shadow: 0 4px 15px var(--primary-glow);
            font-size: 16px; /* Prevent zoom */
        }

        @keyframes heartbeat { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* --- Responsive Logic --- */
        @media (max-width: 768px) {
            .app-container { grid-template-columns: 1fr; }
            aside {
                position: fixed; top: 0; left: 0; width: 85%; max-width: 320px;
                height: 100%; transform: translateX(-100%); box-shadow: var(--shadow-lg);
            }
            aside.open { transform: translateX(0); }
            .close-sidebar-btn { display: block; }
            .mobile-menu-btn { display: block; }
            .line-numbers { display: none; }
            #output { padding-left: 1rem; }
            
            /* Ensure overlay is below sidebar */
            .overlay {
                position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 40;
                opacity: 0; pointer-events: none; transition: opacity 0.3s;
                backdrop-filter: blur(2px);
            }
            .overlay.active { opacity: 1; pointer-events: all; }
            
            .dev-name { font-size: 1.2rem; }
            .credits-wrapper { padding: 1.5rem 1rem; }
        }
        
        @media (min-width: 769px) {
            .line-numbers { display: block; }
            #output { padding-left: 1.5rem; }
        }
    </style>
</head>
<body>

    <!-- Moving Gradient Background -->
    <div class="ambient-glow">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <!-- 1. Welcome Popup (First Popup) -->
    <div class="welcome-overlay" id="welcomeModal">
        <div class="welcome-content">
            <img src="https://z-cdn-media.chatglm.cn/files/2bb9c9d5-0534-48f5-be45-cbd402499068.png?auth_key=1866904011-79589d48c89448d986d7c6aa0aaa82fb-0-36d684d18384e8476e8179b098700a92" alt="Welcome" class="welcome-img">
            <button class="welcome-btn" onclick="closeWelcome()">
                Okay, got it <i class="ph ph-check-circle"></i>
            </button>
        </div>
    </div>
    
    <!-- Mobile Overlay for Sidebar -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- Coffee Support Modal -->
    <div class="modal-overlay" id="coffeeModal">
        <div class="glass-modal">
            <div class="modal-content">
                <div style="font-size: 2rem; margin-bottom: 1rem;">â˜•</div>
                <h2>Enjoying the App?</h2>
                <p>This app is free and open. If you're using the Livery Styler, consider buying the developer a coffee to keep updates coming!</p>
                
                <a href="https://www.buymeacoffee.com/yedhukrizz" target="_blank" class="coffee-btn-modal">
                    Buy Yedhukrizz a coffee
                </a>

                <div class="modal-footer">
                    <button class="close-modal-btn" onclick="closeModal()">Maybe Later</button>
                    <label class="dont-show-check">
                        <input type="checkbox" id="dontShowCheck">
                        Don't show again
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <i class="ph ph-paint-brush-broad"></i>
                    LIVERY STYLER
                </div>
                <button class="close-sidebar-btn" onclick="toggleSidebar()"><i class="ph ph-x"></i></button>
            </div>

            <div class="scroll-area">
                <!-- Core Settings -->
                <details open>
                    <summary>
                        <div class="summary-title"><i class="ph ph-identification-card"></i> Core Settings</div>
                        <i class="ph ph-caret-down chevron"></i>
                    </summary>
                    <div class="panel-content">
                        <div class="input-group">
                            <label>Vehicle Model</label>
                            <input type="text" id="vehicle" value="Porsche 911 GT3" placeholder="e.g. Tesla Model 3">
                        </div>
                        <div class="input-group">
                            <label>Seed</label>
                            <input type="number" id="seed" placeholder="Random">
                        </div>
                    </div>
                </details>

                <!-- Modules -->
                <details open>
                    <summary>
                        <div class="summary-title"><i class="ph ph-cube-transparent"></i> Modules</div>
                        <i class="ph ph-caret-down chevron"></i>
                    </summary>
                    <div class="panel-content">
                        <div class="toggle-row">
                            <span class="toggle-label">Livery Transfer</span>
                            <label class="switch"><input type="checkbox" id="livery" checked><span class="slider"></span></label>
                        </div>
                        <div class="toggle-row">
                            <span class="toggle-label">Wheel Swap</span>
                            <label class="switch"><input type="checkbox" id="wheels"><span class="slider"></span></label>
                        </div>
                        <div class="toggle-row">
                            <span class="toggle-label">Background Match</span>
                            <label class="switch"><input type="checkbox" id="scene"><span class="slider"></span></label>
                        </div>
                    </div>
                </details>

                <!-- Optics -->
                <details>
                    <summary>
                        <div class="summary-title"><i class="ph ph-camera"></i> Optics</div>
                        <i class="ph ph-caret-down chevron"></i>
                    </summary>
                    <div class="panel-content">
                        <div class="input-group">
                            <label>Focal Length</label>
                            <select id="focalLength">
                                <option value="24mm">Wide (24mm)</option>
                                <option value="35mm" selected>Standard (35mm)</option>
                                <option value="85mm">Portrait (85mm)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>DOF (Blur)</label>
                            <div class="range-wrap">
                                <input type="range" id="dof" min="0" max="100" value="20">
                                <span class="range-val" id="dofVal">20%</span>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Render -->
                <details>
                    <summary>
                        <div class="summary-title"><i class="ph ph-faders"></i> Render</div>
                        <i class="ph ph-caret-down chevron"></i>
                    </summary>
                    <div class="panel-content">
                        <div class="input-group">
                            <label>Surface Finish</label>
                            <select id="finish">
                                <option value="matte">Matte</option>
                                <option value="semi_gloss" selected>Semi Gloss</option>
                                <option value="glossy">Ultra Glossy</option>
                                <option value="chrome">Chrome/Metallic</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Quality</label>
                            <select id="resolution">
                                <option value="1080p">HD</option>
                                <option value="2K" selected>2K</option>
                                <option value="4K">4K UHD</option>
                            </select>
                        </div>
                    </div>
                </details>

                <!-- Advanced -->
                <details>
                    <summary>
                        <div class="summary-title"><i class="ph ph-terminal-window"></i> Advanced</div>
                        <i class="ph ph-caret-down chevron"></i>
                    </summary>
                    <div class="panel-content">
                        <div class="input-group">
                            <label>Negative Prompt</label>
                            <textarea id="negPrompt" style="min-height: 60px;">blurry, distorted, cartoon, bad geometry, watermark, text</textarea>
                        </div>
                        <div class="input-group">
                            <label>Stylization Strength</label>
                            <div class="range-wrap">
                                <input type="range" id="strength" min="0" max="100" value="80">
                                <span class="range-val" id="strengthVal">80%</span>
                            </div>
                        </div>
                    </div>
                </details>

            </div>

            <div class="sidebar-footer">
                <button class="btn-generate" onclick="handleGenerate()">
                    <i class="ph ph-lightning-fill"></i> GENERATE JSON
                </button>
            </div>
        </aside>

        <!-- Main Area -->
        <main>
            <div class="top-bar">
                <div class="top-header">
                    <div style="display:flex; align-items:center;">
                        <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="ph ph-list"></i></button>
                        <div class="tabs">
                            <button class="tab-btn active" onclick="switchTab('payload')">JSON Payload</button>
                            <button class="tab-btn" onclick="switchTab('about')">How to Use</button>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn-icon" onclick="handleDownload()"><i class="ph ph-download-simple"></i></button>
                        <button class="btn-icon" onclick="handleCopy()"><i class="ph ph-copy"></i></button>
                    </div>
                </div>
            </div>

            <!-- Payload Tab -->
            <div id="tab-payload" class="tab-content active">
                <div class="editor-wrap">
                    <div class="line-numbers" id="lineNumbers">1</div>
                    <textarea id="output" readonly spellcheck="false"></textarea>
                    <div class="loader" id="loader"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- About Tab -->
            <div id="tab-about" class="tab-content">
                <div class="about-container">
                    
                    <div class="step">
                        <h3><i class="ph ph-image"></i> 1. Gather Images</h3>
                        <p>Save the <strong>Reference Livery</strong> and the <strong>Target Vehicle</strong> to your device.</p>
                    </div>

                    <div class="step">
                        <h3><i class="ph ph-sliders"></i> 2. Configure</h3>
                        <p>Use the menu to define vehicle, optics, and finish. Click <strong>Generate JSON</strong> and then <strong>Copy</strong>.</p>
                    </div>

                    <div class="step">
                        <h3><i class="ph ph-robot"></i> 3. Upload & Paste</h3>
                        <p>Open <strong>Google Gemini</strong>. Attach <strong>both</strong> images. Paste the JSON text directly into the chat.</p>
                    </div>

                    <div class="step">
                        <h3><i class="ph ph-magic-wand"></i> 4. Result</h3>
                        <p>Gemini will analyze the reference, extract the geometry-safe livery, and apply it to your target car.</p>
                    </div>

                    <div class="credits-wrapper">
                        <p class="made-with">Made with <span class="heart-icon">ðŸ’–</span> by</p>
                        <h2 class="dev-name">Yedhukrizz</h2>
                        <a href="https://www.buymeacoffee.com/yedhukrizz" target="_blank" class="coffee-btn-modal" style="width: auto; display: inline-flex;">
                            <i class="ph ph-coffee"></i> Buy the dev a coffee
                        </a>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Welcome Logic ---
        const WELCOME_KEY = 'livery_welcome_seen_v2';
        
        function initWelcome() {
            // Only show if not seen before
            if (localStorage.getItem(WELCOME_KEY) !== 'true') {
                const modal = document.getElementById('welcomeModal');
                modal.style.display = 'flex';
                // Small delay to allow display:flex to apply before adding active class for transition
                setTimeout(() => {
                    modal.classList.add('active');
                }, 10);
            }
        }

        function closeWelcome() {
            const modal = document.getElementById('welcomeModal');
            modal.classList.remove('active'); // Fade out
            
            setTimeout(() => {
                modal.style.display = 'none';
                localStorage.setItem(WELCOME_KEY, 'true');
            }, 500); // Match CSS transition duration
        }

        // Run on load
        window.addEventListener('DOMContentLoaded', initWelcome);


        // --- Main App Logic ---
        const els = {
            vehicle: document.getElementById('vehicle'), seed: document.getElementById('seed'),
            livery: document.getElementById('livery'), wheels: document.getElementById('wheels'), scene: document.getElementById('scene'),
            focalLength: document.getElementById('focalLength'), dof: document.getElementById('dof'), dofVal: document.getElementById('dofVal'),
            finish: document.getElementById('finish'), resolution: document.getElementById('resolution'),
            negPrompt: document.getElementById('negPrompt'), strength: document.getElementById('strength'), strengthVal: document.getElementById('strengthVal'),
            output: document.getElementById('output'), loader: document.getElementById('loader'), lineNumbers: document.getElementById('lineNumbers'),
            modal: document.getElementById('coffeeModal'), dontShowCheck: document.getElementById('dontShowCheck')
        };

        const COFFEE_STORAGE_KEY = 'livery_styler_coffee_hidden';

        // UI Toggles
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        }

        function switchTab(name) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${name}`).classList.add('active');
            const btns = document.querySelectorAll('.tab-btn');
            if(name === 'payload') btns[0].classList.add('active');
            else btns[1].classList.add('active');
        }

        function updateLineNumbers(text) {
            const lines = text.split('\n').length;
            els.lineNumbers.innerHTML = Array(lines).fill(0).map((_, i) => i + 1).join('<br>');
        }

        // --- Modal Logic ---
        function showCoffeePopup() {
            // Check if user checked "Don't show again"
            if (localStorage.getItem(COFFEE_STORAGE_KEY) === 'true') return;
            els.modal.classList.add('active');
        }

        function closeModal() {
            // If checkbox is checked, save preference
            if (els.dontShowCheck.checked) {
                localStorage.setItem(COFFEE_STORAGE_KEY, 'true');
            }
            els.modal.classList.remove('active');
            // Uncheck for next time if they haven't hidden it
            if (localStorage.getItem(COFFEE_STORAGE_KEY) !== 'true') {
                els.dontShowCheck.checked = false;
            }
        }

        // --- Action Handlers (with Modal Trigger) ---
        function handleCopy() {
            navigator.clipboard.writeText(els.output.value);
            showCoffeePopup();
        }

        function handleDownload() {
            const blob = new Blob([els.output.value], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `livery_${els.vehicle.value.replace(/\s+/g, '_')}.json`;
            a.click();
            showCoffeePopup();
        }

        function handleGenerate() {
            updateJSON(true);
            showCoffeePopup();
            if(window.innerWidth <= 768) {
                setTimeout(() => toggleSidebar(), 600);
            }
        }

        // --- Core Logic ---
        function bindRange(input, display) {
            input.addEventListener('input', () => {
                display.textContent = input.value + '%';
                updateJSON(false);
            });
        }
        bindRange(els.dof, els.dofVal);
        bindRange(els.strength, els.strengthVal);

        function generatePayload() {
            const vehicle = els.vehicle.value.trim() || "Generic Vehicle";
            const finish = els.finish.value;
            const focal = els.focalLength.value;
            
            let instructions = [];
            instructions.push(`Act as a Senior Automotive VFX Artist. Perform a high-fidelity style transfer.`);
            instructions.push(`1. Extract Color Palette, Decal Geometry, Typography, Texture, and Graphic Intensity from the Reference Image.`);
            instructions.push(`2. Apply these elements to the Target Vehicle (${vehicle}).`);
            instructions.push(`3. Strict Constraints: Preserve Target Vehicle's 3D perspective, wheel arch geometry, and silhouette. No warping.`);
            instructions.push(`4. Lighting: Match Target Vehicle lighting. Apply style as a skin with realistic shadows.`);
            instructions.push(`5. Render: ${finish} finish. ${focal} focal length. Global Illumination. Raytracing.`);
            if(els.wheels.checked) instructions.push(`6. Wheel Modification: Swap for a complementary design maintaining axle perspective.`);
            if(els.scene.checked) instructions.push(`7. Background: Composite into Reference environment.`);
            else instructions.push(`7. Background: Isolate on neutral studio.`);
            instructions.push(`Output: Photorealistic 8K render.`);

            const seed = els.seed.value ? parseInt(els.seed.value) : Math.floor(Math.random() * 999999);

            const payload = {
                _meta: {
                    app: "Livery Styler Pro",
                    version: "2.2.0-final",
                    timestamp: new Date().toISOString()
                },
                gemini_optimized_prompt: instructions.join(" "),
                configuration: {
                    target_model: vehicle,
                    seed: seed
                },
                visual_parameters: {
                    surface_material: finish,
                    camera_lens: focal,
                    negative_tokens: els.negPrompt.value
                },
                active_modules: {
                    livery_transfer: els.livery.checked,
                    wheel_swap: els.wheels.checked,
                    environment_composite: els.scene.checked
                }
            };

            return JSON.stringify(payload, null, 2);
        }

        function updateJSON(loading = false) {
            if(loading) {
                els.loader.classList.add('active');
                setTimeout(() => {
                    const json = generatePayload();
                    els.output.value = json;
                    updateLineNumbers(json);
                    els.loader.classList.remove('active');
                }, 400);
            } else {
                const json = generatePayload();
                els.output.value = json;
                updateLineNumbers(json);
            }
        }

        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(el => {
            if(el.type !== 'checkbox') el.addEventListener('input', () => updateJSON(false));
            else el.addEventListener('change', () => updateJSON(false));
        });

        // Init
        updateJSON(false);

    </script>
</body>
</html>
